# Feature Specification: Wallet System

**Feature Branch**: `006-wallet-system`
**Created**: 2025-10-27
**Status**: Draft
**MVP**: MVP-4
**Dependencies**: MVP-1 (001-user-identity-system), MVP-3 (005-payment-integration)
**Input**: "Build a wallet system that supports overdraft, balance alerts, payment notifications, and manual admin adjustments for course fees."

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 查看钱包余额和交易记录 (Priority: P0)

用户可以在小程序钱包页面查看当前余额（允许负数）和详细的交易记录，包括运营充值、课程扣费、调整记录等所有资金变动。

**Why this priority**: 余额查看是钱包系统的核心功能，用户需要了解可用余额和资金变动情况。

**Independent Test**: 可独立测试钱包页面，验证余额显示和交易记录是否正确。

**Acceptance Scenarios**:

1. **Given** 用户进入"我的-钱包"页面，**When** 页面加载完成，**Then** 显示当前钱包余额（精确到分，可为负数）
2. **Given** 用户有交易记录，**When** 查看交易历史，**Then** 按时间倒序显示所有交易记录
3. **Given** 用户点击某条交易记录，**When** 查看详情，**Then** 显示交易时间、金额、类型、操作人等信息
4. **Given** 用户没有交易记录，**When** 查看交易历史，**Then** 显示"暂无交易记录"提示
5. **Given** 家庭账号有多个学员，**When** 查看钱包，**Then** 显示家庭共享的统一余额

---

### User Story 2 - 正式课预约立即扣费 (Priority: P0)

用户预约正式课时，系统立即从钱包余额中扣费200元，允许余额不足时变为负数，但欠费后限制新预约。

**Why this priority**: 预约时立即扣费是核心业务逻辑，确保课程费用的及时收取。

**Independent Test**: 预约正式课时验证扣费逻辑和欠费处理是否正确。

**Acceptance Scenarios**:

1. **Given** 用户预约正式课，**When** 点击确认预约，**Then** 系统立即从钱包扣费200元
2. **Given** 钱包余额充足（300元），**When** 扣费200元，**Then** 余额变为100元，生成扣费交易记录
3. **Given** 钱包余额不足（100元），**When** 扣费200元，**Then** 余额变为-100元，允许欠费并生成扣费记录
4. **Given** 用户取消预约，**When** 取消成功，**Then** 系统自动恢复钱包余额200元
5. **Given** 用户欠费（余额为负），**When** 尝试预约新课程，**Then** 弹窗提示"您有欠费，请先充值"并限制预约

---

### User Story 3 - 运营手动调整钱包余额 (Priority: P0)

运营人员在Web后台为指定用户手动调整钱包余额，包含完整的调整原因、收款方式等信息，系统记录详细操作日志。

**Why this priority**: 钱包余额调整是重要的资金管理功能，必须确保操作安全和审计完整。

**Independent Test**: 测试运营后台的余额调整功能，验证所有必填字段和操作日志记录。

**Acceptance Scenarios**:

1. **Given** 运营在后台选择用户，填写调整金额+100元、调整原因"线下充值"、收款方式"微信"、订单号"wx123"，**When** 提交，**Then** 用户余额增加100元
2. **Given** 运营填写调整金额-50元、调整原因"线下退款"、收款方式"银行转账"、订单号"bank456"，**When** 提交，**Then** 用户余额减少50元
3. **Given** 调整成功，**When** 运营查看操作日志，**Then** 记录操作人、时间、金额、原因、收款方式、订单号等完整信息
4. **Given** 调整成功，**When** 系统提示，**Then** 显示"请将收款流水截图发送至飞书群"
5. **Given** 用户查看交易记录，**When** 进入钱包页面，**Then** 显示该笔调整记录和详细信息

---

### User Story 4 - 余额不足预警通知 (Priority: P1)

用户钱包余额低于200元时，系统通过微信服务通知推送预警提醒，帮助用户及时充值。

**Why this priority**: 余额预警能提升用户体验，避免因余额不足影响课程预约。

**Independent Test**: 测试不同余额场景下的预警通知触发逻辑。

**Acceptance Scenarios**:

1. **Given** 用户钱包余额从300元消费到190元，**When** 余额低于200元，**Then** 立即推送微信通知"余额不足200元，请及时充值"
2. **Given** 用户钱包余额已低于200元，**When** 用户再次消费，**Then** 不重复推送预警通知
3. **Given** 用户充值后余额超过200元，**When** 再次消费到200元以下，**Then** 重新触发预警通知
4. **Given** 用户关闭微信通知权限，**When** 余额不足，**Then** 系统记录预警但无法推送，不影响其他功能

---

### User Story 5 - 欠费催缴通知 (Priority: P1)

用户钱包欠费时，系统在多个场景推送催缴通知，提醒用户及时充值避免影响上课。

**Why this priority**: 欠费催缴能确保费用及时收回，维持正常的课程运营。

**Independent Test**: 测试各种催缴场景下的通知推送逻辑。

**Acceptance Scenarios**:

1. **Given** 用户钱包余额变为负数（欠费），**When** 欠费发生，**Then** 立即推送微信通知"您有欠费，请联系运营充值"
2. **Given** 用户欠费，**When** 用户尝试预约新课程，**Then** 弹窗提示"您有欠费，请先充值"，并推送微信通知
3. **Given** 用户欠费且预约的课程即将开课，**When** 开课前1天，**Then** 推送通知"您有欠费，请及时充值，避免影响孩子上课"
4. **Given** 用户欠费多次未处理，**When** 运营查看用户列表，**Then** 该用户显示"欠费催缴"标识

---

### Edge Cases

- **欠费用户限制**: 用户欠费后是否还能上课？ → 已欠费用户可以继续上课，但无法预约新课程
- **余额精度处理**: 钱包余额计算精度问题？ → 使用DECIMAL(10,2)精确到分，避免浮点数精度问题
- **并发扣费**: 多个扣费操作同时进行，如何处理？ → 使用数据库事务和乐观锁，确保数据一致性
- **重复调整**: 运营人员重复提交调整请求，如何处理？ → 前端防重复提交，后端幂等性检查
- **网络异常**: 余额调整时网络中断，如何处理？ → 事务回滚，保持数据一致性
- **误操作撤销**: 运营误操作后如何撤销？ → 支持反向调整操作，记录详细的撤销原因
- **家庭账号透支**: 多个学员共享钱包，透支如何处理？ → 统一从家庭共享余额扣费，允许透支
- **教练出勤标记**: 教练标记出勤时是否扣费？ → 不触发扣费逻辑，费用在预约时已扣除，出勤标记仅用于统计
- **退费规则时间限制**: 用户取消预约后如何处理退费？ → 开课前6小时外可申请退费，6小时内无法退费，课时不扣除

---

## Requirements *(mandatory)*

### Functional Requirements

#### 钱包余额相关
- **FR-001**: 系统必须支持查询用户钱包余额（允许负数）
- **FR-002**: 系统必须支持余额实时更新
- **FR-003**: 系统必须支持家庭账号余额共享
- **FR-004**: 系统必须支持余额精度处理（精确到分）
- **FR-005**: 系统必须允许钱包余额为负数（支持欠费）

#### 预约扣费相关
- **FR-006**: 系统必须在预约正式课时立即扣费200元
- **FR-007**: 系统必须支持余额不足时的扣费（允许变为负数）
- **FR-008**: 系统必须在取消预约时自动恢复钱包余额
- **FR-009**: 系统必须在用户欠费时限制新预约
- **FR-010**: 系统必须生成详细的扣费交易记录
- **FR-011**: 系统必须确保教练出勤标记不触发任何扣费逻辑

#### 运营调整相关
- **FR-012**: 系统必须支持运营手动调整用户钱包余额
- **FR-013**: 系统必须要求填写调整原因（必填）
- **FR-014**: 系统必须要求填写收款方式（微信/支付宝/银行/现金）
- **FR-015**: 系统必须支持填写外部订单号（选填）
- **FR-016**: 系统必须记录运营调整的操作日志
- **FR-017**: 系统必须提示"请将收款流水截图发送至飞书群"

#### 预警通知相关
- **FR-018**: 系统必须在余额低于200元时推送预警通知
- **FR-019**: 系统必须避免重复推送同类型预警通知
- **FR-020**: 系统必须在用户欠费时立即推送催缴通知
- **FR-021**: 系统必须在用户尝试预约时推送欠费提醒
- **FR-022**: 系统必须在课程开课前1天推送欠费催缴通知

#### 交易记录相关
- **FR-023**: 系统必须记录所有钱包交易（充值、扣费、调整）
- **FR-024**: 系统必须支持交易记录查询和筛选
- **FR-025**: 系统必须显示详细的交易信息（时间、金额、类型、操作人）
- **FR-026**: 系统必须确保交易记录不可篡改

### Key Entities

- **wallet**: 钱包实体，存储用户余额信息
  - 核心属性: id, user_id, balance(可为负数), created_at, updated_at
  - 业务规则: 每个用户只有一个钱包，余额可以为负数，支持欠费

- **wallet_transaction**: 钱包交易记录实体，记录所有资金变动
  - 核心属性: id, wallet_id, type, amount, balance_after, payment_method, external_order_no, note, admin_id, created_at
  - 业务规则: 每次余额变动都产生交易记录，包含完整的操作信息

- **balance_alert**: 余额预警记录实体，记录预警通知发送情况
  - 核心属性: id, user_id, alert_type, threshold_amount, sent_at, notification_status
  - 业务规则: 避免重复发送同类型预警，记录通知发送状态

- **arrears_reminder**: 欠费催缴记录实体，记录催缴通知情况
  - 核心属性: id, user_id, reminder_type, reminder_scene, sent_at, notification_status
  - 业务规则: 记录不同场景的催缴通知，支持多频次催缴

---

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 钱包余额查询准确率100%
- **SC-002**: 预约扣费操作准确率100%
- **SC-003**: 余额调整操作成功率99.5%（排除异常情况）
- **SC-004**: 交易记录完整性100%
- **SC-005**: 余额预警通知及时率100%
- **SC-006**: 欠费催缴通知覆盖率100%
- **SC-007**: 钱包页面响应时间小于2秒

---

## Assumptions

- 假设运营人员有权限访问Web后台进行充值操作
- 假设用户理解钱包使用规则和欠费机制
- 假设微信服务通知功能正常工作
- 假设网络环境稳定，能够完成余额调整操作
- 假设数据库事务机制正常工作，支持并发操作

---

## Out of Scope (MVP-4 不实现)

- ❌ 自动充值功能（留到后期）
- ❌ 提现功能（留到后期）
- ❌ 转账功能（用户间转账）
- ❌ 钱包冻结/解冻功能（留到后期）
- ❌ 多币种支持（留到后期）
- ❌ 积分奖励系统（留到后期）

---

## Open Questions

1. **[NEEDS CLARIFICATION]** 欠费用户是否可以继续上课？
   - 建议: 允许继续上课，但限制新预约，确保用户权益

2. **[NEEDS CLARIFICATION]** 余额预警的触发频率如何控制？
   - 建议: 每个用户每天最多触发1次同类型预警，避免骚扰

3. **[NEEDS CLARIFICATION]** 运营调整钱包是否需要审核流程？
   - 建议: 无需审核，直接生效，通过操作日志和飞书截图确保透明度