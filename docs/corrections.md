# 百适体操馆小程序 - Spec文档修正指令

**修正日期**: 2025-10-27  
**修正版本**: v1.0  
**紧急程度**: 🔴 高优先级  

---

## 📋 修正总览

根据与产品负责人的深度交互,当前生成的MVP-3(支付)和MVP-4(钱包)的spec文档存在**多处严重偏离需求**的问题,需要立即修正。同时,**MVP-5(运营后台)的spec完全缺失**,需要补充生成。

### 修正范围

| MVP编号 | MVP名称 | 当前状态 | 修正动作 |
|---------|---------|---------|---------|
| 005 | 支付集成系统 | ⚠️ 需大幅修正 | 删除订单超时/待支付状态/动态定价等 |
| 006 | 钱包系统 | ⚠️ 需大幅修正 | 添加欠费支持/余额预警/催缴通知等 |
| 007 | 运营后台系统 | ❌ 完全缺失 | 需要全新生成spec |

---

## 🔴 MVP-3 (005-payment-integration) 修正清单

### 【必须删除】的错误内容

#### 1. 删除"订单超时关闭"机制

**❌ 错误内容**:
- User Story中提到"支付订单超时30分钟自动关闭"
- Functional Requirements中包含"订单超时自动关闭"
- Edge Cases中包含"订单超时处理"

**✅ 正确逻辑**:
- 点击"立即支付"→直接调起微信支付
- 支付成功→创建预约记录
- 支付失败→立即释放名额,提示"支付失败,请重新支付"
- **不需要"待支付"状态,不需要订单超时机制**

**修正指令**:
```markdown
删除所有与"订单超时"/"待支付状态"相关的内容,包括:
- User Story中的超时场景描述
- Functional Requirements中的FR-XXX(订单超时自动关闭)
- Edge Cases中的"订单超时处理"
```

---

#### 2. 删除"支持订单状态管理"

**❌ 错误内容**:
- order表包含status字段,枚举值包含pending(待支付)/paid(已支付)/closed(已关闭)
- 支持查询"待支付订单"

**✅ 正确逻辑**:
- 点击支付→直接调起微信支付→支付成功或失败
- order表的status字段仅需要:paid(已支付)/refunded(已退款)
- **不需要pending(待支付)和closed(已关闭)状态**

**修正指令**:
```markdown
修正order表的status字段枚举值:
- 删除: pending(待支付), closed(已关闭)
- 保留: paid(已支付), refunded(已退款)
```

---

#### 3. 删除"动态定价"功能

**❌ 错误内容**:
- User Story中提到"系统弹出支付确认窗口,显示课程实际价格(默认200元/节)"
- 暗示课程价格可以动态调整

**✅ 正确逻辑**:
- 体验课价格固定200元,不支持动态定价
- 课程表的price字段对体验课固定为200

**修正指令**:
```markdown
修正User Story 1的描述:
- 删除"课程实际价格(默认200元/节)"
- 改为"体验课固定价格200元"
- 删除所有暗示"动态定价"的描述
```

---

#### 4. 删除"支付记录查询"功能

**❌ 错误内容**:
- User Story 5: 支付记录查询
- 包含用户查询自己的支付记录功能

**✅ 正确逻辑**:
- 支付记录查询属于"钱包系统"的交易记录功能
- 支付系统仅处理微信支付和退款,不包含记录查询

**修正指令**:
```markdown
删除User Story 5"支付记录查询",移至MVP-4(钱包系统)的交易记录功能
```

---

### 【必须添加】的缺失内容

#### 5. 添加"支付失败立即释放名额"逻辑

**✅ 需要添加的内容**:
- Edge Case: 支付失败后名额立即释放,其他用户可以预约
- Functional Requirement: 系统必须在支付失败后立即释放课程名额

**修正指令**:
```markdown
在Edge Cases中添加:
- **支付失败名额释放**: 用户支付失败后,课程名额立即释放,其他用户可以继续预约

在Functional Requirements中添加:
- FR-XXX: 系统必须在支付失败后立即释放课程名额
```

---

#### 6. 添加"体验课按OpenID限制一次"逻辑

**✅ 需要添加的内容**:
- 每个微信OpenID只能预约一次体验课
- 重复预约时提示"您已预约过体验课,无法重复预约"

**修正指令**:
```markdown
在Functional Requirements中添加:
- FR-XXX: 系统必须限制每个微信OpenID只能预约一次体验课
- FR-XXX: 重复预约时提示"您已预约过体验课,无法重复预约"

在Edge Cases中添加:
- **重复预约限制**: 用户已预约过体验课,再次预约时系统拒绝并提示
```

---

## 🔴 MVP-4 (006-wallet-system) 修正清单

### 【必须删除】的错误内容

#### 1. 删除"钱包余额不能为负数"限制

**❌ 错误内容**:
- User Story中提到"余额不足时扣费失败"
- Functional Requirements中包含"余额不足时拒绝预约"

**✅ 正确逻辑**:
- 钱包允许欠费,余额可以为负数
- 预约正式课时自动扣款200元,即使余额不足也允许预约(变为负数)
- 欠费后限制新预约,但已欠费的用户可以继续上课

**修正指令**:
```markdown
删除所有"余额不足时拒绝预约"的描述,改为:
- 余额不足时允许预约,钱包余额变为负数
- 欠费后限制新预约(弹窗提示"您有欠费,请先充值")
```

---

#### 2. 删除"运营确认消课后自动扣费"逻辑

**❌ 错误内容**:
- User Story中提到"运营确认消课后,系统自动从钱包扣款"

**✅ 正确逻辑**:
- 预约正式课时立即扣款200元(不是消课后扣款)
- 取消预约时恢复钱包余额
- **不需要运营确认消课**

**修正指令**:
```markdown
修正User Story 2的描述:
- 删除"运营确认消课后自动扣款"
- 改为"预约正式课时自动扣款200元"
```

---

#### 3. 删除"不允许透支"限制

**❌ 错误内容**:
- Functional Requirements中包含"不允许透支"

**✅ 正确逻辑**:
- 允许欠费透支,但欠费后限制新预约

**修正指令**:
```markdown
删除"不允许透支"的限制,改为:
- 允许欠费(余额可为负数)
- 欠费后限制新预约
```

---

### 【必须添加】的缺失内容

#### 4. 添加"余额不足预警(200元)"功能

**✅ 需要添加的内容**:
- 余额低于200元时推送微信通知"余额不足200元,请及时充值"

**修正指令**:
```markdown
添加User Story:
### User Story X - 余额不足预警 (Priority: P1)

用户钱包余额低于200元时,系统推送微信服务通知提醒充值。

**Acceptance Scenarios**:
1. **Given** 用户钱包余额从300元消费到190元, **When** 余额低于200元, **Then** 立即推送微信通知"余额不足200元,请及时充值"
2. **Given** 用户钱包余额已低于200元, **When** 用户再次消费, **Then** 不重复推送预警通知
```

---

#### 5. 添加"欠费催缴通知"功能

**✅ 需要添加的内容**:
- 欠费时推送一次催缴通知
- 用户下次发起预约动作时再次推送
- 开课前1天推送"您有欠费,请及时充值,避免影响孩子上课"

**修正指令**:
```markdown
添加User Story:
### User Story X - 欠费催缴通知 (Priority: P1)

用户钱包欠费时,系统在多个场景推送催缴通知。

**Acceptance Scenarios**:
1. **Given** 用户钱包余额为负数(欠费), **When** 欠费发生, **Then** 立即推送微信通知"您有欠费,请联系运营充值"
2. **Given** 用户欠费, **When** 用户尝试预约新课程, **Then** 弹窗提示"您有欠费,请先充值",并推送微信通知
3. **Given** 用户欠费且预约的课程即将开课, **When** 开课前1天, **Then** 推送通知"您有欠费,请及时充值,避免影响孩子上课"
```

---

#### 6. 添加"后台手动充值钱包"功能

**✅ 需要添加的内容**:
- 运营在后台手动调整用户钱包余额
- 记录调整原因/收款方式/订单号/备注
- 提示"请将收款流水截图发送至飞书群"

**修正指令**:
```markdown
添加Data Requirements:
- **wallet_transaction表必须包含以下字段**:
  - type: 交易类型(topup=充值/consume=消费/refund=退款/adjust=调整)
  - amount: 交易金额
  - balance_after: 交易后余额
  - payment_method: 收款方式(wechat/alipay/bank/cash)
  - external_order_no: 外部订单号(支付宝流水号/银行转账单号等)
  - note: 备注(运营填写)
  - admin_id: 操作人ID(运营后台调整时记录)
```

---

## 🔴 MVP-5 (007-admin-dashboard) 完全缺失,需要生成

### 核心功能清单

MVP-5(运营后台系统)是**完全缺失**的,需要重新生成完整的spec.md,包含以下7个核心功能模块:

#### 1. 后台登录与权限管理

**核心需求**:
- 管理员通过账号密码登录
- 支持基于权限的菜单显示
- 支持细粒度权限配置(如"钱包调整权限"可单独授予)

---

#### 2. 用户管理与查询

**核心需求**:
- 支持按手机号/微信昵称查询用户
- 显示用户的所有档案/钱包余额/预约记录
- 显示累计充值/累计消费/欠费金额
- 欠费用户标红显示,右上角显示"催缴"按钮

---

#### 3. 钱包余额调整(重点!)

**核心需求**:
- 管理员手动调整用户钱包余额(增加/减少)
- 必填字段:调整金额/调整原因/收款方式/订单号/备注
- 调整后生成wallet_transaction记录(type=adjust)
- 提示"请将收款流水截图发送至飞书群"
- 记录操作日志(操作人/操作时间/操作前后数据)

**表单字段**:
| 字段名 | 类型 | 是否必填 | 说明 |
|--------|------|---------|------|
| 调整金额 | 数字 | ✅ 必填 | 正数=充值,负数=扣款 |
| 调整原因 | 下拉选择 | ✅ 必填 | 线下充值/线下退款/误操作更正/其他 |
| 收款方式 | 下拉选择 | ✅ 必填 | 微信/支付宝/银行转账/现金 |
| 订单号 | 文本 | 选填 | 支付宝流水号/银行转账单号等 |
| 备注 | 文本 | 选填 | 自由填写 |

---

#### 4. 体验课跟进管理

**核心需求**:
- 显示所有已完成的体验课记录
- 体验课完成后自动标记"待跟进"(红色高亮)
- 运营可标记"已跟进"
- 点击用户姓名跳转到用户详情页,可直接调整钱包充值

---

#### 5. 课程管理

**核心需求**:
- 支持创建/修改/删除课程
- 删除有预约的课程时提示"该课程有X人预约,确认删除将自动退款/恢复余额"
- 所有操作记录到操作日志

---

#### 6. 数据看板

**核心需求**:
- 显示核心指标:总用户数/今日新增用户/本月预约数/本月收入/欠费用户数
- 支持点击指标卡片跳转到详情页
- 数据每5分钟自动刷新

---

#### 7. 操作日志

**核心需求**:
- 记录所有后台操作(登录/用户管理/钱包调整/课程管理)
- 记录操作人/操作时间/操作模块/操作内容/操作前后数据
- 支持按操作模块/操作人筛选日志

---

### 生成指令

```markdown
请根据以上7个核心功能模块,生成完整的MVP-5(运营后台系统)spec.md,包含:
- 7个User Story(对应7个功能模块)
- 完整的Functional Requirements
- 完整的Success Criteria
- 完整的Edge Cases
- 完整的Data Requirements
```

---

## ✅ 修正后的MVP架构

修正完成后,项目的MVP架构应该是:

| MVP编号 | MVP名称 | 核心内容 | 用户故事数 | 预计工期 |
|---------|---------|---------|-----------|---------|
| 001 | 用户身份系统 | 微信登录+档案管理 | 5个 | 2周 |
| 002 | 课程展示与基础预约 | 本周课程+固定班+体验课预约 | 6个 | 2-3周 |
| 003 | 候补队列与补课 | 候补队列+补课管理 | 5个 | 1-2周 |
| 004 | 私教课系统 | 私教课预约+教练信息 | 4个 | 1周 |
| **005** | **支付集成系统** | **体验课微信支付+退款** | **3个** | **1周** |
| **006** | **钱包系统** | **钱包余额+自动扣款+预警催缴** | **4个** | **1周** |
| **007** | **运营后台系统** | **用户管理+钱包调整+数据看板+日志** | **7个** | **2-3周** |

**总计**: 7个MVP,34个用户故事,预计10-14周完整交付

---

## 📋 修正优先级

### 🔴 P0 - 立即修正(影响开发)

1. ✅ 修正MVP-3(支付):删除订单超时/待支付状态/动态定价
2. ✅ 修正MVP-4(钱包):添加欠费支持/余额预警/催缴通知
3. ✅ 生成MVP-5(运营后台):完整的7个功能模块

### 🟡 P1 - 后续补充(提升质量)

4. 为MVP-3/4/5生成完整的plan.md
5. 为MVP-3/4/5生成完整的tasks.md

---

## 🎯 验收标准

修正完成后,请提交以下3个文档供验收:

1. ✅ `specs/005-payment-integration/spec.md` (修正版)
2. ✅ `specs/006-wallet-system/spec.md` (修正版)
3. ✅ `specs/007-admin-dashboard/spec.md` (新生成)

每个文档必须通过以下检查:
- ✅ 所有User Story与产品需求一致
- ✅ 所有Functional Requirements准确无误
- ✅ 无遗漏核心功能
- ✅ 无包含不需要的功能

---

**文档生成时间**: 2025-10-27 19:10  
**文档版本**: 1.0.0  
**产品负责人**: CC  
**需求规划顾问**: Perplexity AI
